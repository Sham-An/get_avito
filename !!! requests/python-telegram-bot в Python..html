<!DOCTYPE html><html lang="ru"><head><title>Библиотека python-telegram-bot в Python.</title><meta charset="utf-8"><meta name="description" content="Пакет python-telegram-bot предоставляет чистый интерфейс Python для Telegram Bot API. Он совместим с версиями Python 3.6+. Пакет python-telegram-bot также может работать с PyPy3 (официально не поддерживается)"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#e9e9e9"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="yandex-verification" content="7fc92983a5ae9810"><link rel="stylesheet" href="/static/css/min.css"><link rel="icon" type="image/svg" href="/favicon.svg"><meta property="og:image" content="/favicon.svg"><link rel="manifest" href="/packages/webapp.manifest"><style>.frame-xl {min-height: calc(100vh - 140px);overflow:auto;}blockquote {padding-left: 1rem;font-style: italic;border-left: #6c757d 3px solid;}footer div {background-color: #e9e9e9;}code {background-color: #eeeeee; color:rgb(17, 17, 17);font-size:87%;}pre{border:1px silver solid;padding:5px;font-size:85%;display:block;width:100%;background-color: #eeeeee;color:#212529}.crimson, h3>em>code,h4>em>code,h5>em>code{line-height:1.2;margin-top:15px;color:crimson;background-color:#e9e9e9;}.big{font-size:120%}.small{font-size:80%}.small-grey{font-size:75%; color: dimgrey;}.table-bordered td{font-size:90%;}.table-bordered .color td{background-color:#E0E0E0; font-size:110%;text-align:center;}div.highlight{margin-bottom: 1rem;}.breadcrumb {padding:2px 7px;margin-bottom:0px;font-size:85%;}.no-gutters>.col-lg-9{margin-top:15px;}.card-header,.card-body{padding:10px 5px 5px 5px;}.overflow-auto.card-body {max-height: 600px;}.card-body>ul{padding:5px 5px 5px 20px; font-size:85%;}ol,ul,.card-body>ul>li{margin-top:5px;}.hr{width:90%;border:rgb(166, 209, 166) 1px solid;}.illuminate,.illuminate code{background-color:rgb(255, 255, 115);transition: 1s ease;}div[id^='yandex_rtb_R-A']{margin-bottom:10px;}#back-to-top {position:fixed;bottom:25px;left:25px;display:none;z-index:1001;}#msg-email,#msg-error {cursor: pointer;}#scroll{transition: 1s linear;}.blinking {background-color: rgb(51, 161, 51);}@media(max-width:768px){#container-msg-error {text-align:left!important;}}@media (max-width: 540px) {body{font-size:1.05rem !important;}pre{font-size:90%;}}#scroll::-webkit-scrollbar-track {-webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);background-color: #f5f5f5;}#scroll::-webkit-scrollbar {width: 3px;background-color: #f5f5f5;}#scroll::-webkit-scrollbar-thumb {background-color: #6c757d;}</style><link rel="dns-prefetch" href="//yastatic.net/"><link rel="dns-prefetch" href="//mc.yandex.ru/"><link rel="dns-prefetch" href="//yandex.ru/"><script>window.yaContextCb=window.yaContextCb||[]</script><script async src="https://yandex.ru/ads/system/context.js"></script></head><body><div class="container-xl"><header><nav class="navbar navbar-expand-lg navbar-light rounded border" style="background-color: #e9e9e9;"><a class="navbar-brand" href="/" title="Python3, наиболее полный справочник и самоучитель.">DOCS Python3</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item "><a class="nav-link" href="/tutorial/" title="Справочник по языку Python3 на русском языке">Справочник Python</a></li><li class="nav-item "><a class="nav-link" href="/standart-library/" title="Документация по стандартной библиотеки языка Python3">Стандартная библиотека</a></li><li class="nav-item active"><a class="nav-link" href="/packages/" title="Сторонние популярные пакеты и модули">Другие модули</a></li><li class="nav-item "><a class="nav-link text-danger" href="/search/">Поиск</a></li><li class="nav-item"><span class="nav-link" id="msg-email">Контакты</span></li></ul></div></nav></header></div><div class="container-xl"><div class="row no-gutters"><div class="col-sm-12 col-md-6"><div class="ya-share2" data-services="vkontakte,odnoklassniki,messenger,whatsapp,viber,telegram,pocket,moimir"></div></div><div id="container-msg-error" class="col-sm-12 col-md-6 text-right"><span id="msg-error" class="badge badge-warning">Сообщить об ошибке.</span></div></div></div><div class="frame-xl"><h1 class="text-center mt-3">Библиотека python-telegram-bot в Python.</h1><nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="/packages/" title="Часто используемые в Python3 сторонние модули.">Сторонние пакеты и модули Python3.</a></li><li class="breadcrumb-item active" aria-current="page">Библиотека python-telegram-bot в Python.</li></ol></nav><div class="row no-gutters"><div class="col-lg-9 pr-lg-1"><h2 class='h3'>Создание Telegram каналов и ботов.</h2><div id="important-info"><div id="yandex_rtb_R-A-1582037-2"></div><script>window.yaContextCb.push(()=>{Ya.Context.AdvManager.render({blockId: 'R-A-1582037-2',renderTo: 'yandex_rtb_R-A-1582037-2',})})</script></div><p><a href="/packages/biblioteka-python-telegram-bot-python/" title="Библиотека python-telegram-bot в Python.">Пакет <code>python-telegram-bot</code></a> предоставляет чистый интерфейс Python для <a href="https://core.telegram.org/bots/api">Telegram Bot API</a>. Он совместим с версиями Python 3.6+. Пакет <code>python-telegram-bot</code> также может работать с <a href="/tutorial/ustanovka-python/pypy3-ustanovka-ispolzovanie-os-linux/" title="Установка и использование PyPy3, совместимость с Python3.">PyPy3</a> (официально не поддерживается), хотя раньше было много проблем.</p><p>В дополнение к <a href="#telegram.Bot">чистой реализации API</a> эта библиотека содержит ряд высокоуровневых классов, которые делают разработку ботов простой и понятной. Эти классы содержатся в модуле <a href="#telegram.ext"><code>telegram.ext</code></a>.</p><p>Реализация чистого API без расширений <code>telegram.ext</code> доступна как отдельный пакет <code>python-telegram-bot-raw</code>.</p><h4>Установка пакета <code>python-telegram-bot</code> в виртуальное окружение:</h4><div class="highlight"><pre><span></span><span class="c1"># создаем виртуальное окружение, если нет</span>
$ python3 -m venv .telegram --prompt TelegramBot
<span class="c1"># активируем виртуальное окружение </span>
$ <span class="nb">source</span> .telegram/bin/activate
<span class="c1"># ставим модуль python-telegram-bot</span>
<span class="o">(</span>TelegramBot<span class="o">)</span>:~$ python -m pip install -U python-telegram-bot
<span class="c1"># или установка чистого API без расширений</span>
<span class="o">(</span>TelegramBot<span class="o">)</span>:~$ python -m pip install -U python-telegram-bot-raw
</pre></div><p><a href="/packages/biblioteka-python-telegram-bot-python/" title="Библиотека python-telegram-bot в Python.">Пакет <code>python-telegram-bot</code></a> в основном будет разбираться на примерах. Содержание, обзорного/вводного материала по библиотеке ниже. Меню с материалами по всему разделу - справа. Поехали...</p><h3><u>Содержание</u>:</h3><ul><li><a href="#telegram.Bot">Чистая реализация официального Telegram Bot API</a>;<ul><li><a href="#Bot.send">Как отвечать/получать сообщения на чистом API</a>;</li><li><a href="#Bot.primer">Пример бота для ответа на сообщения на чистом API</a>;</li></ul></li><li><a href="#telegram.ext">Модуль расширения <code>telegram.ext</code></a>;<ul><li><a href="#create.bot">Создание Telegram bot, шаг за шагом</a>;</li><li><a href="#InlineQuery">Режим встроенных запросов</a>;</li><li><a href="#primer">Весь код созданного бота</a>.</li></ul></li></ul><hr><p><a id="telegram.Bot"></a></p><h2>Чистая реализация официального Telegram Bot API.</h2><p>API бота предоставляется через класс <code>telegram.Bot</code>. Методы, определенные в <code>telegram.Bot</code> являются эквивалентами в виде методов <a href="/tutorial/pep-rukovodstvo-stilju-koda-python/soglashenija-imenah/" title="Соглашения об именах в Python"><code>snake_case</code></a>, описанных в официальной документации <a href="https://core.telegram.org/bots/api">Telegram Bot API</a>. Для удобства, также доступны точные названия методов в виде <code>camelCase</code>, указанные в документации Telegram. Так, например, вызов <code>telegram.Bot.send_message</code> совпадает с вызовом метода <code>telegram.Bot.sendMessage</code>. </p><p>Все классы объектов Telegram Bot API расположены в основном модуле пакета <code>telegram</code>, например, класс объекта <code>Message</code> доступен как <code>telegram.Message</code>.</p><p>Чтобы сгенерировать токен доступа, необходимо пообщаться с <a href="https://t.me/botfather" title="botfather"><code>@BotFather</code></a> и выполнить несколько простых шагов, описанных в разделе <a href="/packages/biblioteka-python-telegram-bot-python/sozdat-telegram-bota-botfather/" title="Команды и оповещения @BotFather в Telegram#.">Команды и оповещения <code>@BotFather</code> в Telegram</a>.</p><p>Чтобы получить представление об API и о том, как его использовать с пакетом <code>python-telegram-bot</code>, запустите интерпретатор Python и выполните следующие несколько шагов.</p><p>Сначала создаем экземпляр <code>telegram.Bot</code>. Константу <code>TOKEN</code> следует заменить токеном API, который был получен от <code>@BotFather</code>:</p><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">telegram</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">TOKEN</span> <span class="o">=</span> <span class="s1">&#39;Замените эту строку на token, полученный от @BotFather&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">TOKEN</span><span class="p">)</span>
<span class="c1"># Чтобы проверить правильность учетных данных, вызываем метод bot.getMe():</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">get_me</span><span class="p">())</span>
<span class="c1"># {&quot;first_name&quot;: &quot;Toledo&#39;s Palace Bot&quot;, &quot;username&quot;: &quot;ToledosPalaceBot&quot;}</span>
</pre></div><p><u>Примечание</u>: боты не могут инициировать чаты с пользователями. Пользователь должен либо добавить их в группу, либо сначала отправить им сообщение. Для подключения к создаваемому боту или каналу в основном используются ссылки, такие как <code>https://telegram.me/bot_username</code> или можно попробовать найти бота по имени в своем десктопном или мобильном приложении.</p><p><a id="Bot.send"></a></p><h3>Как отвечать/получать сообщения на чистом API?</h3><p>Для получения сообщений, отправленных боту, можно использовать метод API <code>.getUpdates</code>.</p><p><u>Примечание</u>: не нужно использовать <code>.get_updates</code>, если пишете своего бота с модулем расширения <a href="#telegram.ext"><code>telegram.ext</code></a>, поскольку <code>telegram.ext.Updater</code> получает все обновления/сообщения в автоматическом режиме.</p><p>На чистом API это выглядит следующим образом:</p><div class="highlight"><pre><span></span><span class="n">updates</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_updates</span><span class="p">()</span>
<span class="nb">print</span><span class="p">([</span><span class="n">upd</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">upd</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">])</span>
</pre></div><p>Получение изображения, отправленного боту:</p><div class="highlight"><pre><span></span><span class="n">updates</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_updates</span><span class="p">()</span>
<span class="nb">print</span><span class="p">([</span><span class="n">upd</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">photo</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span> <span class="k">if</span> <span class="n">upd</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">photo</span><span class="p">])</span>
</pre></div><p>Для отправки сообщения всегда нужен будет <code>chat_id</code>:</p><div class="highlight"><pre><span></span><span class="n">chat_id</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_updates</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">chat_id</span>
<span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;I&#39;m a bot, please talk to me!&quot;</span><span class="p">)</span>
</pre></div><p><u>Примечание</u>. Метод <code>.send_message</code>, как и любой из методов <code>send_*</code> класса <code>Bot</code> возвращает экземпляр класса <code>Message</code>, поэтому его можно использовать в коде позже.</p><p>Ответ на конкретное сообщение, полученное в обновлении:</p><div class="highlight"><pre><span></span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;I&#39;m sorry Dave I&#39;m afraid I can&#39;t do that.&quot;</span><span class="p">)</span>
</pre></div><p><u>Примечание</u>. Существуют эквиваленты этого метода для ответа с фотографиями, аудио и т. д., а так же аналогичные эквиваленты встречаются по всей библиотеке <code>python-telegram-bot</code>.</p><p><a id="Bot.primer"></a></p><h3>Пример бота для ответа на сообщения на чистой реализации API Telegram.</h3><p>Простой бот для ответа на сообщения Telegram. Пример построен на чистом API Telegram, который реализует пакет <code>python-telegram-bot</code>. </p><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">telegram</span>
<span class="kn">from</span> <span class="nn">telegram.error</span> <span class="kn">import</span> <span class="n">NetworkError</span><span class="p">,</span> <span class="n">Unauthorized</span>

<span class="n">UPDATE_ID</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">bot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Эхо сообщение отправленное пользователем.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">UPDATE_ID</span>
    <span class="c1"># Запрашиваем обновление после последнего update_id</span>
    <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_updates</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="n">UPDATE_ID</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">UPDATE_ID</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">update_id</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># бот может получать обновления без сообщений</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="c1"># не все сообщения содержат текст</span>
            <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="c1"># Ответ на сообщение</span>
                <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ECHO: </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Запускаем бота.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">UPDATE_ID</span>
    <span class="c1"># Токен авторизации бота Telegram</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="s1">&#39;TOKEN&#39;</span><span class="p">)</span>

    <span class="c1"># получаем первый ожидающий `update_id`</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">UPDATE_ID</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_updates</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update_id</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">UPDATE_ID</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">echo</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NetworkError</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Unauthorized</span><span class="p">:</span>
            <span class="c1"># Пользователь удалил или заблокировал бота.</span>
            <span class="n">UPDATE_ID</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div><p><a id="telegram.ext"></a></p><h2>Модуль расширения <code>telegram.ext</code>.</h2><p>Модуль расширений <code>telegram.ext</code> построен поверх <a href="#telegram.Bot">чистой реализации Telegram Bot API</a>. Он предоставляет простой в использовании интерфейс и снимает с программиста некоторую работу.</p><p>Он состоит из нескольких классов, но два наиболее важных - это <code>telegram.ext.Updater</code> и <code>telegram.ext.Dispatcher</code>.</p><div id="yandex_rtb_R-A-1582037-3"></div><script>window.yaContextCb.push(()=>{Ya.Context.AdvManager.render({blockId: 'R-A-1582037-3',renderTo: 'yandex_rtb_R-A-1582037-3',})})</script><p>Класс <code>Updater</code> постоянно слушает сервер Telegram, получает новые сообщения и передает их классу <code>Dispatcher</code>. Если создать объект <code>Updater</code>, то он автоматически создаст <code>Dispatcher</code> и свяжет их вместе с очередью. Затем в объекте <code>Dispatcher</code> можно зарегистрировать обработчики разных типов, которые будут сортировать полученные объектом <code>Updater</code> сообщения. Поступающие сообщения будут обрабатываться в соответствии с зарегистрированными обработчиками и передавать их в функцию обратного вызова, которую необходимо определить.</p><p>Еще нужно знать и понимать, что экземпляр <code>Updater</code> реализует все методы класса <code>telegram.Bot</code> (API Telegram), которые будут связаны с данным <code>Updater</code>. У экземпляра <code>Dispatcher</code>, в свою очередь, есть так называемый контекст <code>context</code>, который, при регистрации любого <a href="/packages/biblioteka-python-telegram-bot-python/tipy-obrabotchikov/" title="Типы обработчиков модуля python-telegram-bot в Python.">обработчика сообщений</a> передается в функцию обратного вызова этого обработчика (кстати в нее так же передается <code>updater</code>). Так вот, у этого контекста то же есть экземпляр класса <code>telegram.Bot</code>, только он связан с конкретным сообщением, которое попало в эту функцию обратного вызова.</p><p>Каждый обработчик является экземпляром подкласса класса <code>telegram.ext.Handler</code>. Пакет <code>python-telegram-bot</code> предоставляет <a href="/packages/biblioteka-python-telegram-bot-python/tipy-obrabotchikov/" title="Типы обработчиков модуля python-telegram-bot в Python.">классы обработчиков</a> почти на все стандартные случаи, но если нужно что-то конкретное, то можно создать собственный обработчик, наследуясь от класса <code>Handler</code>.</p><p><a id="create.bot"></a></p><h3>Создание Telegram bot, шаг за шагом.</h3><p>Во-первых, нужно создать объект <code>Updater</code>. В коде ниже замените константу <code>TOKEN</code> на токен API вашего бота. Для более быстрого доступа к <code>Dispatcher</code>, в который <code>Updater</code> посылает сообщение, можно создать его отдельно:</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">Updater</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="s1">&#39;Замените эту строку на token, полученный от @BotFather&#39;</span>
<span class="c1"># получаем экземпляр `Updater`</span>
<span class="n">updater</span> <span class="o">=</span> <span class="n">Updater</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">use_context</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># получаем экземпляр `Dispatcher`</span>
<span class="n">dispatcher</span> <span class="o">=</span> <span class="n">updater</span><span class="o">.</span><span class="n">dispatcher</span>
</pre></div><p><u>Примечание</u>. Аргумент <code>use_context=True</code> (по умолчанию <code>False</code>) - это специальный аргумент, необходимый только для <code>python-telegram-bot</code> меньше 12 версии. Это обеспечивает лучшую обратную совместимость со старыми версиями и дает пользователям время для обновления. Начиная с 13-ой версии, значение аргумента <code>use_context=True</code> используется по умолчанию (указывать не нужно).</p><p>Чтобы знать, когда и почему что-то не работает должным образом, настроим <a href="/standart-library/paket-logging-python/" title="Пакет logging, ведение журнала в Python.">модуль ведения журнала логов</a>:</p><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div><p><u>Примечание</u>. если хотите узнать больше об обработке исключений с <code>python-telegram-bot</code>, прочтите подраздел об &quot;<a href="/packages/biblioteka-python-telegram-bot-python/obrabotka-oshibok/" title="Обработка исключений модуля python-telegram-bot в Python.">Обработка исключений</a>&quot;.</p><p>Теперь определим функцию, которая должна обрабатывать определенный тип сообщения, отправленных боту:</p><div class="highlight"><pre><span></span><span class="c1"># Обратите внимание, что из обработчика в функцию </span>
<span class="c1"># передаются экземпляры `update` и `context` </span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># `bot.send_message` это метод Telegram API</span>
    <span class="c1"># `update.effective_chat.id` - определяем `id` чата, </span>
    <span class="c1"># откуда прилетело сообщение </span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="s2">&quot;I&#39;m a bot, please talk to me!&quot;</span><span class="p">)</span>
</pre></div><p>Цель состоит в том, чтобы эта функция вызывалась каждый раз, когда бот получает сообщение с серверов Telegram, содержащее команду <code>/start</code>. Для этого можно использовать класс <code>CommandHandler</code> (один из предоставленных подклассов <code>Handler</code>) и зарегистрировать его в <code>Dispatcher</code>:</p><div class="highlight"><pre><span></span><span class="c1"># импортируем обработчик CommandHandler, </span>
<span class="c1"># который фильтрует сообщения с командами</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">CommandHandler</span>
<span class="c1"># говорим обработчику, если увидишь команду `/start`,</span>
<span class="c1"># то вызови функцию `start()`</span>
<span class="n">start_handler</span> <span class="o">=</span> <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># добавляем этот обработчик в `dispatcher`</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">start_handler</span><span class="p">)</span>
</pre></div><p>И это все, что нужно! Для запуска бота дописываем команду:</p><div class="highlight"><pre><span></span><span class="c1"># говорим экземпляру `Updater`, </span>
<span class="c1"># слушай сервера Telegram.</span>
<span class="n">updater</span><span class="o">.</span><span class="n">start_polling</span><span class="p">()</span>
</pre></div><p>Начните чат со своим ботом и введите команду <code>/start</code> - если все пойдет хорошо, он ответит.</p><p>Созданный бот может отвечать только на команду <code>/start</code>. Добавим еще один обработчик, который прослушивает обычные сообщения. Для этого используем класс <code>MessageHandler</code> - другой подкласс <code>Handler</code>, для вывода всех текстовых сообщений:</p><div class="highlight"><pre><span></span><span class="c1"># функция обратного вызова</span>
<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># добавим в начало полученного сообщения строку &#39;ECHO: &#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ECHO: &#39;</span> <span class="o">+</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> 
    <span class="c1"># `update.effective_chat.id` - определяем `id` чата, </span>
    <span class="c1"># откуда прилетело сообщение </span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>    

<span class="c1"># импортируем обработчик `MessageHandler` и класс с фильтрами</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">MessageHandler</span><span class="p">,</span> <span class="n">Filters</span>
<span class="c1"># говорим обработчику `MessageHandler`, если увидишь текстовое </span>
<span class="c1"># сообщение (фильтр `Filters.text`)  и это будет не команда </span>
<span class="c1"># (фильтр ~Filters.command), то вызови функцию `echo()`</span>
<span class="n">echo_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">Filters</span><span class="o">.</span><span class="n">text</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">Filters</span><span class="o">.</span><span class="n">command</span><span class="p">),</span> <span class="n">echo</span><span class="p">)</span>
<span class="c1"># регистрируем обработчик `echo_handler` в экземпляре `dispatcher`</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">echo_handler</span><span class="p">)</span>
</pre></div><p>С этого момента создаваемый бот должен обрабатывать все получаемые текстовые сообщения, а так же работать с командой <code>/start</code>, но не будет реагировать на любые другие команды (например, <code>/your_command</code>) .</p><p><u>Примечание</u>: как только новые обработчики добавляются  в диспетчер, они сразу вступают в силу.</p><p><u>Примечание</u>. Класс <a href="/packages/biblioteka-python-telegram-bot-python/filtry-soobschenij/" title="Все о фильтрации сообщений python-telegram-bot в Python."><code>telegram.ext.Filters</code></a> содержит ряд так называемых фильтров, которые фильтруют входящие сообщения по тексту, изображениям, обновлениям статуса и т. д. Любое сообщение, которое возвращает <code>True</code> хотя бы для одного из фильтров, переданных в <code>MessageHandler</code>, будет принято. Если необходимо, то можно написать свои собственные фильтры. Подробнее смотрите раздел &quot;<a href="/packages/biblioteka-python-telegram-bot-python/filtry-soobschenij/" title="Все о фильтрации сообщений python-telegram-bot в Python.">Все о фильтрации сообщений <code>python-telegram-bot</code> в Python</a>&quot;.</p><p>Добавим боту другую функциональность и реализуем команду <code>/caps</code>, которая будет принимать какой-то текст в качестве аргумента и отвечать на него тем же текстом, только в верхнем регистре. Аргументы команды (например <code>/caps any args</code>) будут поступать в функцию обратного вызова в виде списка <code>[&#39;any&#39;, &#39;args&#39;]</code>, разделенного по пробелам:</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">caps</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># если аргументы присутствуют</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="c1"># объединяем список в строку и </span>
        <span class="c1"># переводим ее в верхний регистр</span>
        <span class="n">text_caps</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># `update.effective_chat.id` - определяем `id` чата, </span>
        <span class="c1"># откуда прилетело сообщение </span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="n">text_caps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># если в команде не указан аргумент</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;No command argument&#39;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;send: /caps argument&#39;</span><span class="p">)</span>

<span class="c1"># обработчик команды &#39;/caps&#39;</span>
<span class="n">caps_handler</span> <span class="o">=</span> <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;caps&#39;</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span>
<span class="c1"># регистрируем обработчик в диспетчере</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">caps_handler</span><span class="p">)</span>
</pre></div><p><u>Примечание</u>. Обратите внимание на использование <code>context.args</code>. Объект <a href="/packages/biblioteka-python-telegram-bot-python/obekt-callbackcontext/" title="Объект CallbackContext модуля python-telegram-bot в Python."><code>CallbackContext</code></a> будет иметь много разных атрибутов в зависимости от того, какой обработчик используется.</p><p><a id="InlineQuery"></a></p><h3>Режим встроенных запросов.</h3><p>Еще одна интересная особенность официального Telegram Bot API - это <a href="https://core.telegram.org/bots/inline">режим встроенных запросов</a> к ботам. Помимо отправки команд в личных сообщениях или группах, пользователи могут взаимодействовать с ботом с помощью встроенных запросов. Если встроенные запросы включены, то пользователи могут вызвать вашего бота, введя его имя <code>@bot_username</code> и запрос в поле ввода текста в любом чате. Запрос отправляется боту в обновлении. Таким образом, люди могут запрашивать контент у ботов в любом из своих чатов, групп или каналов, вообще не отправляя им никаких отдельных сообщений.</p><p>Если необходимо реализовать такую функциональность для своего бота, то сначала необходимо изменить конфигурацию в <code>@BotFather</code>, включив этот режим при помощи команды <code>/setinline</code>. Иногда требуется какое-то время, пока бот не зарегистрируется в качестве встроенного бота на вашем клиенте. Можно ускорить процесс, перезапустив приложение Telegram или иногда просто нужно немного подождать.</p><p>Здесь используется ряд новых типов:</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineQueryResultArticle</span><span class="p">,</span> <span class="n">InputTextMessageContent</span>
<span class="k">def</span> <span class="nf">inline_caps</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">inline_query</span><span class="o">.</span><span class="n">query</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Convert to UPPER TEXT&#39;</span><span class="p">,</span>
            <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">answer_inline_query</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">inline_query</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">InlineQueryHandler</span>
<span class="n">inline_caps_handler</span> <span class="o">=</span> <span class="n">InlineQueryHandler</span><span class="p">(</span><span class="n">inline_caps</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">inline_caps_handler</span><span class="p">)</span>
</pre></div><p>Теперь бот может работать и через режим встроенных запросов.</p><p>Пользователи могут попытаться отправить боту команды, которые он не понимает, поэтому можно использовать обработчик <code>MessageHandler</code> с фильтром <code>Filters.command</code>, чтобы отвечать на все команды, которые не были распознаны предыдущими обработчиками.</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Sorry, I didn&#39;t understand that command.&quot;</span><span class="p">)</span>

<span class="n">unknown_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">Filters</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">unknown</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">unknown_handler</span><span class="p">)</span>
</pre></div><p><u>Примечание</u>: этот обработчик должен быть добавлен последним. Если добавить его раньше, то он сработает до того, как <code>CommandHandlers</code> сможет просмотреть сообщение. После обработки сообщения, все дальнейшие обработчики игнорируются. Чтобы обойти это, можно передать группу целочисленных ключевых аргументов в метод <code>Dispatcher.add_handler</code> со значением, отличным от 0.</p><div id="yandex_rtb_R-A-1582037-4"></div><script>window.yaContextCb.push(()=>{Ya.Context.AdvManager.render({blockId: 'R-A-1582037-4',renderTo: 'yandex_rtb_R-A-1582037-4',})})</script><p>Остановить бота можно командой <code>updater.stop()</code>.</p><p><u>Примечание</u>. Объект <code>Updater</code> запускается в отдельном потоке, это хорошо, если вы запускаете команды в интерпретаторе Python. Но если запустить скрипт с написанным ботом, то вероятно, удобнее будет останавливать бота, нажатием <kbd>Ctrl</kbd>+<kbd>C</kbd>, отправив сигнал процессу бота. Для этого, после запуска бота командой <code>updater.start_polling()</code> допишите в коде следующей строкой команду <code>updater.idle()</code>.</p><p><a id="primer"></a></p><h3>Весь код созданного бота:</h3><div class="highlight"><pre><span></span><span class="c1"># sample-bot.py</span>
<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineQueryResultArticle</span><span class="p">,</span> <span class="n">InputTextMessageContent</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">Updater</span><span class="p">,</span> <span class="n">CommandHandler</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">MessageHandler</span><span class="p">,</span> <span class="n">Filters</span><span class="p">,</span> <span class="n">InlineQueryHandler</span>

<span class="n">TOKEN</span> <span class="o">=</span> <span class="s1">&#39;Замените эту строку на token, полученный от @BotFather&#39;</span>
<span class="n">updater</span> <span class="o">=</span> <span class="n">Updater</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">TOKEN</span><span class="p">)</span>
<span class="n">dispatcher</span> <span class="o">=</span> <span class="n">updater</span><span class="o">.</span><span class="n">dispatcher</span>

<span class="c1"># функция обработки команды &#39;/start&#39;</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="s2">&quot;I&#39;m a bot, please talk to me!&quot;</span><span class="p">)</span>

<span class="c1"># функция обработки текстовых сообщений</span>
<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ECHO: &#39;</span> <span class="o">+</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> 
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>    

<span class="c1"># функция обработки команды &#39;/caps&#39;</span>
<span class="k">def</span> <span class="nf">caps</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">text_caps</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="n">text_caps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;No command argument&#39;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;send: /caps argument&#39;</span><span class="p">)</span>

<span class="c1"># функция обработки встроенного запроса</span>
<span class="k">def</span> <span class="nf">inline_caps</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">inline_query</span><span class="o">.</span><span class="n">query</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Convert to UPPER TEXT&#39;</span><span class="p">,</span>
            <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">answer_inline_query</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">inline_query</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

<span class="c1"># функция обработки не распознных команд</span>
<span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Sorry, I didn&#39;t understand that command.&quot;</span><span class="p">)</span>

<span class="c1"># обработчик команды &#39;/start&#39;</span>
<span class="n">start_handler</span> <span class="o">=</span> <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">start_handler</span><span class="p">)</span>    

<span class="c1"># обработчик текстовых сообщений</span>
<span class="n">echo_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">Filters</span><span class="o">.</span><span class="n">text</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">Filters</span><span class="o">.</span><span class="n">command</span><span class="p">),</span> <span class="n">echo</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">echo_handler</span><span class="p">)</span>

<span class="c1"># обработчик команды &#39;/caps&#39;</span>
<span class="n">caps_handler</span> <span class="o">=</span> <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;caps&#39;</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">caps_handler</span><span class="p">)</span>

<span class="c1"># обработчик встроенных запросов </span>
<span class="n">inline_caps_handler</span> <span class="o">=</span> <span class="n">InlineQueryHandler</span><span class="p">(</span><span class="n">inline_caps</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">inline_caps_handler</span><span class="p">)</span>

<span class="c1"># обработчик не распознных команд</span>
<span class="n">unknown_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">Filters</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">unknown</span><span class="p">)</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">unknown_handler</span><span class="p">)</span>

<span class="c1"># запуск прослушивания сообщений</span>
<span class="n">updater</span><span class="o">.</span><span class="n">start_polling</span><span class="p">()</span>
<span class="c1"># обработчик нажатия Ctrl+C</span>
<span class="n">updater</span><span class="o">.</span><span class="n">idle</span><span class="p">()</span>
</pre></div></div><div class="col-lg-3"><aside class="card shadow-sm border-secondary mb-2"><div class="card-header text-center bg-secondary text-white"><h4 class="h4">Содержание раздела:</h4></div><div id="scroll" class="overflow-auto card-body"><ul><li><a  href="/packages/biblioteka-python-telegram-bot-python/brief-description/" title="Краткий обзор раздела: Как перезапустить телеграмм-бота в случае ошибки bot.polling? в Python.">КРАТКИЙ ОБЗОР МАТЕРИАЛА.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/sozdat-telegram-bota-botfather/" title="Команды и оповещения @BotFather в Telegram.">Команды и оповещения @BotFather в Telegram.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/tipy-obrabotchikov/" title="Типы обработчиков модуля python-telegram-bot в Python.">Типы обработчиков модуля python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/filtry-soobschenij/" title="Все о фильтрации сообщений python-telegram-bot в Python.">Все о фильтрации сообщений python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/hranenie-dannyh/" title="Хранение промежуточных данных, связанных с ботом, пользователем и чатом в Python.">Хранение промежуточных данных python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/nastrojki-umolchaniju/" title="Добавление настроек по умолчанию для Telegram бота.">Настройки по умолчанию модуля python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/planirovschik-soobschenij/" title="Периодическая отправка сообщений, с заданным интервалом в Python.">Планировщик сообщений модуля python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/fajlami-media-url-adresami/" title="Часто используемые методы при работе с файлами, media и URL-адресами в Python.">Работа с файлами, модуль python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/menju-klaviatury/" title="Создание на Telegram меню из кнопок (встроенные клавиатуры).">Меню из кнопок, модуль python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/obekt-callbackcontext/" title="Объект контекста context модуля расширения telegram.ext.">Объект CallbackContext модуля python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/ispolzovanie-webhook/" title="Подключения к Telegram через webhook.">Использование Webhook в модуле python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/obrabotka-oshibok/" title="Реализация собственного обработчика ошибок для Telegram бота.">Обработка исключений модуля python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/vstroennyj-rezhim-bota/" title="Базовый пример Telegram бота с режимом встроенных запросов в Python.">Создание Inline-бота, python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/rabota-oprosami/" title="Пример бота, работающего с опросами/викторинами в Python.">Работа с опросами из python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/sozdanie-razgovorov-conversationhandler/" title="Создание беседы при помощи ConversationHandler.">Создание разговоров ConversationHandler в python-telegram-bot.</a></li><li><a  href="/packages/biblioteka-python-telegram-bot-python/perezapusk-telegramm-bota/" title="Перезапуск телеграмм-бота в случае ошибки.">Как перезапустить телеграмм-бота в случае ошибки bot.polling?.</a></li></ul></div></aside><div id="right-row"><div id="yandex_rtb_R-A-1582037-1"></div><script>window.yaContextCb.push(()=>{Ya.Context.AdvManager.render({renderTo: 'yandex_rtb_R-A-1582037-1',blockId: 'R-A-1582037-1'})})</script></div></div></div><div id="dialogModal"></div></div><div class="container-xl"><footer><div id="back-to-top" class="btn btn-info">Вверх</div><div class="card rounded"><div class="card-body"><p class="card-text"><a href="/" title="Справочная документация по языку Python3.">DOCS-Python.ru</a>™, 2022 г. <span class="small text-secondary">(<span class="text-danger">Внимание!</span> При копировании материала ссылка на источник обязательна)</span></p></div></div></footer></div><script src="/static/js/min.js"></script><script>function getStyle(sel) {var sayings = new Map();sayings.set("display", "none").set("visibility", "hidden").set("position", "absolute");for (var [key, value] of sayings) {if ($(sel).css(key) == value) return true;if ($(sel).children().css(key) == value) return true;}}function sendError(msg, comment, h1) {$.ajax({type: "POST",url: "/send/error/",data: {'msg':msg, 'comment':comment, 'h1':h1},success: function(data) {var a = data.split('|');var resp = a.pop();if (resp.indexOf('ok') == 0) {$.cookie('msgErr', '0');$('#errSend').remove();a.forEach(function(item) {b = item.split('#', 2);$('#'+b[0]).html(b[1]);});} else if (resp.indexOf('fatal') == 0) {$('#errSend').remove();a.forEach(function(item) {b = item.split('#', 2);$('#'+b[0]).html(b[1]);});} else {$('#errSend').text('Отправить').attr('disabled', false);$('#errTitle').css("color", "red").html(a.join('<br>'));}}});}function sendEmail(user, email, subject, msg) {$.ajax({type: "POST",url: "/send/email/",data: {'user':user, 'email':email, 'subject':subject, 'msg':msg},success: function(data){var a = data.split('|');var resp = a.pop();if (resp.indexOf('ok') == 0) {$('#emailSend').remove();a.forEach(function(item) {b = item.split('#', 2);$('#'+b[0]).html(b[1]);});} else if (resp.indexOf('fatal') == 0) {$('#emailSend').remove();a.forEach(function(item) {b = item.split('#', 2);$('#'+b[0]).html(b[1]);});} else {$('#emailSend').text('Отправить').attr('disabled', false);$('#emailTitle').css("color", "brown").text('Исправте ошибки в письме.');a.forEach(function(item) {b = item.split('#');$('#'+b[0]).css("background-color", "rgb(252, 228, 228)");$('#_'+b[0]).text(b[1])});}}});}$(document).ready(function(){var h1 = $('h1').text();var doc_width = $(document).width();$(window).on('load', function () {$("#scroll").addClass("blinking");setTimeout(function(){$("#scroll").removeClass("blinking");}, 300);setTimeout(function(){var ublock = 'false';var v = getStyle('div[id*="1582037"]');if(typeof yandex_context_callbacks=='undefined'||v===true) {ublock = 'true';$.get("/static/form/donate.html", function(data) {if (doc_width > 972) {$('#right-row').html(data);} else {$('#important-info').html(data);$('#right-row').remove();}setTimeout(function(){if (getStyle('#donate')===true){ublock = 'fack';$('pre,code').css('color','#eefeee').parent().removeClass();$('nav,aside,#msg-error').remove();}}, 200);});}}, 1200);$(function() {var box = $('#right-row'); var top = box.offset().top;var width = box.width();$(document).on('scroll', function(){var windowpos = $(window).scrollTop();if(windowpos < top) {box.css('position', 'static');} else {box.css('position', 'fixed');box.css('width', width).css('top', 0);}});});});$(document).scroll(function() {if ($(this).scrollTop() > 300) {$('#back-to-top').fadeIn();} else {$('#back-to-top').fadeOut();}});$('#back-to-top').click(function () {$('body,html').animate({scrollTop: 0}, 200);return false;});$("a[href^='#']").click(function(){$('.illuminate').removeClass('illuminate');var href = $(this).attr('href').replace('#', '');var el_a = $("a[id='" + href + "']");$("html, body").animate({scrollTop: el_a.offset().top + "px"}, 200);el_a.parent().next().addClass("illuminate");return false;});$('#msg-error').click(function() {$('.modal-backdrop').removeClass('show').hide();$("#dialogModal").html('');$("#dialogModal").load("/static/form/modalError.html", function(response,status,xhr) {if(status == "success") {$("#dialogModal").html(response);$('#modalError').modal('show');$('#errPageName').text(h1);}});});$('#dialogModal').on('click', '#errSend', function() {$('#errSend').text('Идет отправка').attr('disabled', true);$('#emailTitle').css("color", "black").text('Ждите. Идет отправка...');var msg = $('#errText').val();var comment = $('#errCommentText').val();sendError(msg, comment, h1);});$('#msg-email').click(function() {$('.modal-backdrop').removeClass('show').hide();$("#dialogModal").html('');$("#dialogModal").load("/static/form/modalEmail.html", function(response,status) {if(status == "success") {$("#dialogModal").html(response);$('#modalEmail').modal('show');}});});$('#dialogModal').on('click', '#emailSend', function() {$('#emailSend').text('Идет отправка').attr('disabled', true);$('#emailTitle').css("color", "black").text('Ждите. Идет отправка...');var user = $('#user').val();var email = $('#email').val();var subject = $('#subject').val();var msg = $('#msg').val();sendEmail(user, email, subject, msg);});var right_menu = $("#scroll>ul>li:first").text();if (doc_width < 972 && right_menu) {var razdel = $(".breadcrumb-item:eq(1)").text().replace('.', ':');$('#navbarSupportedContent>ul>li:last').text(razdel);$("#scroll>ul").insertAfter('#navbarSupportedContent>ul>li:last');$('aside').remove();}});</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(67309303, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/67309303" style="position:absolute; left:-9999px;" alt="" /></div></noscript><script src="//yastatic.net/share2/share.js"></script></body></html>